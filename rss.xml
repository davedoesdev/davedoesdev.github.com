<?xml version="1.0"?>
<rss version="2.0">
  <channel>
    <title>Dave Does Dev</title>
    <link>http://www.davedoesdev.com</link>
    <pubDate>2012-10-18 08:45:01 +0100</pubDate>
    <item>
      <title>Vu Meter</title>
      <link>http://www.davedoesdev.com/vu-meter</link>
      <pubDate>2012-10-07</pubDate>
      <description>&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
  &lt;head&gt;
    &lt;meta charset="utf-8"&gt;
    &lt;title&gt;Vu Meter - Dave Does Dev&lt;/title&gt;
    &lt;meta name="author" content="David Halls"&gt;

    &lt;!-- HTML5 shim, for IE6-8 support of HTML elements --&gt;
    &lt;!--[if lt IE 9]&gt;
      &lt;script src="http://html5shim.googlecode.com/svn/trunk/html5.js"&gt;&lt;/script&gt;
    &lt;![endif]--&gt;
    &lt;link href="/assets/my_hooligan/stylesheets/bootstrap/css/bootstrap.min.css?0.01886627275255237" type="text/css" rel="stylesheet" media="all"&gt;
&lt;link href="/assets/my_hooligan/stylesheets/bootstrap/css/bootstrap-responsive.min.css?0.35615353169353237" type="text/css" rel="stylesheet" media="all"&gt;
&lt;link href="/assets/my_hooligan/stylesheets/css-social-buttons/zocial.stripped.css?0.5624796485258514" type="text/css" rel="stylesheet" media="all"&gt;
&lt;link href="/assets/my_hooligan/stylesheets/css/darkstrap.css?0.3895548848436393" type="text/css" rel="stylesheet" media="all"&gt;
&lt;link href="/assets/my_hooligan/stylesheets/css/style.css?0.4233122322511461" type="text/css" rel="stylesheet" media="all"&gt;
&lt;link href="/assets/my_hooligan/widgets/google_prettify/stylesheets/sunburst.css?0.6351827873145749" type="text/css" rel="stylesheet" media="all"&gt;

&lt;script src="/assets/my_hooligan/javascripts/jquery.min.js?0.43317827740949233"&gt;&lt;/script&gt;
&lt;script src="/assets/my_hooligan/javascripts/bootstrap.min.js?0.5774679738347547"&gt;&lt;/script&gt;
 
    
    &lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;
    &lt;link rel="shortcut icon" href="/assets/media/favicon.ico"&gt;
    &lt;!-- fav and touch icons --&gt;
  &lt;!-- Update these with your own images
    &lt;link rel="shortcut icon" href="images/favicon.ico"&gt;
    &lt;link rel="apple-touch-icon" href="images/apple-touch-icon.png"&gt;
    &lt;link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png"&gt;
    &lt;link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png"&gt;
  --&gt;
  &lt;/head&gt;

  &lt;body&gt;
    &lt;div class="navbar"&gt;
      &lt;div class="navbar-inner"&gt;
        &lt;div class="container"&gt;
          &lt;!-- .btn-navbar is used as the toggle for collapsed navbar content --&gt;
          &lt;a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse"&gt;
            &lt;span class="icon-bar"&gt;&lt;/span&gt;
            &lt;span class="icon-bar"&gt;&lt;/span&gt;
            &lt;span class="icon-bar"&gt;&lt;/span&gt;
          &lt;/a&gt;      


          &lt;a class="brand" href="/"&gt;Dave Does Dev&lt;/a&gt;


          &lt;div class="nav-collapse"&gt;
            &lt;ul class="nav"&gt;
                
                  &lt;li&gt;&lt;a href="/archive"&gt;Archive&lt;/a&gt;&lt;/li&gt;
                
                  &lt;li&gt;&lt;a href="/tags"&gt;Tags&lt;/a&gt;&lt;/li&gt;
                
                  &lt;li&gt;&lt;a href="/categories"&gt;Categories&lt;/a&gt;&lt;/li&gt;
                
                  &lt;li&gt;&lt;a href="/pages"&gt;Pages&lt;/a&gt;&lt;/li&gt;
                
                  &lt;li&gt;&lt;a href="/about"&gt;About Me&lt;/a&gt;&lt;/li&gt;
                &lt;li&gt;
                  &lt;a href="https://www.github.com/davedoesdev" class="hidden-desktop" target="_self"&gt;Github&lt;/a&gt;
                &lt;/li&gt;
                &lt;li&gt;
                  &lt;a href="http://www.twitter.com/davedoesdev" class="hidden-desktop" target="_self"&gt;Twitter&lt;/a&gt;
                &lt;/li&gt;
                &lt;li&gt;
                  &lt;a href="http://www.linkedin.com/in/dhalls" class="hidden-desktop" target="_self"&gt;LinkedIn&lt;/a&gt;
                &lt;/li&gt;
              &lt;li&gt;
                &lt;a href="/rss.xml" class="hidden-desktop" target="_self"&gt;RSS&lt;/a&gt;
              &lt;/li&gt;
            &lt;/ul&gt;
            &lt;ul class="nav pull-right social visible-desktop"&gt;
              &lt;li class="divider-vertical"&gt;&lt;/li&gt;
                &lt;li&gt;
                  &lt;a href="https://www.github.com/davedoesdev" class="zocial github icon" target="_self"&gt;
                    &lt;span class="hidden-desktop"&gt;Github&lt;/span&gt;
                  &lt;/a&gt;
                &lt;/li&gt;
                &lt;li&gt;
                  &lt;a href="http://www.twitter.com/davedoesdev" class="zocial twitter icon" target="_self"&gt;
                    &lt;span class="hidden-desktop"&gt;Twitter&lt;/span&gt;
                  &lt;/a&gt;
                &lt;/li&gt;
                &lt;li&gt;
                  &lt;a href="http://www.linkedin.com/in/dhalls" class="zocial linkedin icon" target="_self"&gt;
                    &lt;span class="hidden-desktop"&gt;LinkedIn&lt;/span&gt;
                  &lt;/a&gt;
                &lt;/li&gt;
              &lt;li&gt;
                &lt;a href="/rss.xml" class="zocial rss icon" target="_self"&gt;
                  &lt;span class="hidden-desktop"&gt;RSS&lt;/span&gt;
                &lt;/a&gt;
              &lt;/li&gt;
            &lt;/ul&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;

    &lt;div class="container"&gt;
      &lt;div class="content"&gt;
        &lt;div class="page-header"&gt;
  &lt;h1&gt;
    Vu Meter 
  &lt;/h1&gt;
&lt;/div&gt;

&lt;div class="row"&gt;
  &lt;div class="span9"&gt;
    &lt;p&gt;I wanted a large on-screen volume indicator showing:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;The microphone amplification level, changing as you adjust it (by pressing
keys, for example).&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Whether the microphone is muted.&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;The current microphone level, changing as you speak into the microphone.&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Here&amp;#39;s what I did.&lt;/p&gt;

&lt;h2 id="toc_0"&gt;xosdd&lt;/h2&gt;

&lt;p&gt;&lt;a href="http://sourceforge.net/projects/libxosd/"&gt;XOSD&lt;/a&gt; does the real work here.
It displays text anywhere on your X desktop and it looks like an old skool TV/VCR&amp;#39;s
display.&lt;/p&gt;

&lt;p&gt;XOSD is a library to build into your own projects. &lt;a href="http://phintsan.kapsi.fi/xosdd.html"&gt;xosdd&lt;/a&gt; puts XOSD into a daemon which listens on a named pipe for
commands using a custom protocol.&lt;/p&gt;

&lt;p&gt;I made a &lt;a href="https://gist.github.com/3847336#file_xosdd_0.0.patch"&gt;2-line patch&lt;/a&gt; to xosdd in order to support display of text in the centre of the screen.&lt;/p&gt;

&lt;p&gt;First, I created some named pipes:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;for p in /tmp/{audio,display,vumeter,level}_control
do
  if ! test -p &amp;quot;$p&amp;quot;
  then
    mkfifo &amp;quot;$p&amp;quot;
  fi
done
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;display_control&lt;/strong&gt; and &lt;strong&gt;vumeter_control&lt;/strong&gt; are for communicating with xosdd:&lt;/p&gt;

&lt;dl&gt;
&lt;dt&gt;/tmp/display_control&lt;/dt&gt;
&lt;dd&gt;For commands to display the microphone amplification level and muted state.&lt;/dd&gt;
&lt;/dl&gt;

&lt;dl&gt;
&lt;dt&gt;/tmp/vumeter_control&lt;/dt&gt;
&lt;dd&gt;For commands to display the current microphone level.&lt;/dd&gt;
&lt;/dl&gt;

&lt;p&gt;&lt;strong&gt;audio_control&lt;/strong&gt; and &lt;strong&gt;level_control&lt;/strong&gt; are for receving user input and
capturing raw microphone level data. They won&amp;#39;t be used with xosdd directly
but by processes which sit in front of xosdd.&lt;/p&gt;

&lt;dl&gt;
&lt;dt&gt;/tmp/audio_control&lt;/dt&gt;
&lt;dd&gt;For user actions: microphone volume up/down, mute/unmute and turn current level monitoring on/off. These will be sent when the user presses
corresponding keys on the keyboard.&lt;/dd&gt;
&lt;/dl&gt;

&lt;dl&gt;
&lt;dt&gt;/tmp/level_control&lt;/dt&gt;
&lt;dd&gt;For raw microphone level data.&lt;/dd&gt;
&lt;/dl&gt;

&lt;p&gt;I ran xosdd twice - once for displaying the amplification level and muted state
and once for displaying the current level:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;xosdd -l 4 -t 2 -f &amp;#39;-*-terminus-bold-r-*-*-*-240-100-100-*-*-*-*&amp;#39; /tmp/display_control &amp;amp;

cat &amp;gt; /tmp/display_control &amp;lt;&amp;lt;EOF
align center
pos middle
EOF

xosdd -l 4 -f &amp;#39;-*-terminus-bold-r-*-*-*-240-100-100-*-*-*-*&amp;#39; /tmp/vumeter_control &amp;amp;

cat &amp;gt; /tmp/vumeter_control &amp;lt;&amp;lt;EOF
color orange
align center
pos middle
EOF
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Both default to displaying information in the centre of the screen. I used the
&lt;a href="http://terminus-font.sourceforge.net"&gt;Terminus&lt;/a&gt; font here but you may wish to
use something else. XOSD only supports bitmap fonts.&lt;/p&gt;

&lt;h2 id="toc_1"&gt;Displaying amplification level and muted state&lt;/h2&gt;

&lt;p&gt;Let&amp;#39;s define a bash function which we can call at any time to get xosdd to
display the microphone volume level and whether it&amp;#39;s muted.&lt;/p&gt;

&lt;p&gt;You&amp;#39;ll need to set &lt;strong&gt;ctlIn&lt;/strong&gt; to the name of your microphone under ALSA.
Run &lt;strong&gt;amixer&lt;/strong&gt; without arguments to list all your devices. On one of my systems
it&amp;#39;s called &lt;strong&gt;Mic&lt;/strong&gt;, on another it&amp;#39;s called &lt;strong&gt;Capture&lt;/strong&gt;.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;function display_input
{
  amixer get &amp;quot;$ctlIn&amp;quot; | egrep -o &amp;#39;([0-9]+%)|(\[off\])&amp;#39; |
  {
  local state=On color=yellow percent
  while read v
  do
    if test &amp;quot;$v&amp;quot; = &amp;quot;[off]&amp;quot;
    then
      state=Off
      color=red
    else
      percent=&amp;quot;$v&amp;quot;
    fi
  done
  cat &amp;gt; /tmp/display_control &amp;lt;&amp;lt;EOF
color $color
string 0 &amp;quot;Microphone: $state&amp;quot;
bar 1 $percent
EOF
  }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;What we&amp;#39;re doing is calling &lt;strong&gt;amixer&lt;/strong&gt; to get information about the device
and filtering for amplification level and muted state. Note the egrep option
&lt;strong&gt;-o&lt;/strong&gt; outputs each match &lt;em&gt;part&lt;/em&gt; on a separate line.&lt;/p&gt;

&lt;p&gt;If the microphone is muted, the colour is set to red; unmuted is yellow.
We display text for the muted state on the first line and a bar indicating
the amplification level on the second.&lt;/p&gt;

&lt;h2 id="toc_2"&gt;Monitoring current microphone level&lt;/h2&gt;

&lt;p&gt;This is a bit more complicated but not too bad. Basically, we want to read
raw microphone level data from &lt;strong&gt;/tmp/level_control&lt;/strong&gt; and turn it into commands
for xosdd on &lt;strong&gt;tmp/vumeter_control&lt;/strong&gt;. &lt;/p&gt;

&lt;p&gt;At the same time, we want to keep the amplification and muted state display
updated so the user can press microphone up/down keys and see both the
amplification and current levels change.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;(
while true
do
  gawk &amp;#39;/^.+%$/ {print &amp;quot;&amp;quot;; fflush(); printf(&amp;quot;string 2 \&amp;quot;Current Level\&amp;quot;\nbar 3 %s\n&amp;quot;, $NF) &amp;gt;&amp;quot;/tmp/vumeter_control&amp;quot;; close(&amp;quot;/tmp/vumeter_control&amp;quot;)}&amp;#39; /tmp/level_control |
  (
  first=yes
  while read
  do
    if test $first = yes
    then
      echo &amp;#39;timeout -1&amp;#39; &amp;gt; /tmp/display_control
      first=no
    fi
    display_input
  done
  echo hide &amp;gt; /tmp/vumeter_control
  echo -e &amp;#39;hide\ntimeout 2&amp;#39; &amp;gt; /tmp/display_control
  )
done
) &amp;amp;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Node that we need to disable the &lt;strong&gt;timeout&lt;/strong&gt; on the amplification and muted
display while monitoring is active.&lt;br&gt;
When we stop receiving raw microphone level data, both displays are
hidden straight away. &lt;/p&gt;

&lt;h2 id="toc_3"&gt;Main control loop&lt;/h2&gt;

&lt;p&gt;Now we need to control the microphone displays. We want to:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;Allow the user to increase and decrease the microphone amplification level
and then display the level on the screen.&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Mute and unmute the microphone and display the status on the screen.&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Start and stop monitoring of the current microphone level, and its display.&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Here&amp;#39;s how we do this:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;while true
do
  exec 3&amp;lt; /tmp/audio_control
  while read cmd &amp;lt;&amp;amp;3
  do
    case $cmd in
      d)
        amixer -q set &amp;quot;$ctlIn&amp;quot; ${ctlDelta}-
        display_input
        ;;

      u)
        amixer -q set &amp;quot;$ctlIn&amp;quot; ${ctlDelta}+
        display_input
        ;;

      t)
        amixer -q set &amp;quot;$ctlIn&amp;quot; toggle
        display_input
        ;;

      m)
        if test &amp;quot;$recpid&amp;quot;
        then
          kill $recpid
          unset recpid
        else
          arecord -vvv /dev/null -V mono &amp;gt; /tmp/level_control &amp;amp;
          recpid=$!
        fi
        ;;
    esac
  done
  exec 3&amp;lt;&amp;amp;-
done
) &amp;amp;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The &lt;strong&gt;arecord&lt;/strong&gt; command supplies raw microphone level data.&lt;/p&gt;

&lt;p&gt;You&amp;#39;ll have to set &lt;strong&gt;ctlDelta&lt;/strong&gt; to the amount you want the microphone level
changed when &lt;strong&gt;d&lt;/strong&gt; and &lt;strong&gt;u&lt;/strong&gt; commands are received. This will either be a
percentage (e.g. 5%) or a number (e.g. 1) depending on your audio device.
You&amp;#39;ll have to try both to see what works for you.&lt;/p&gt;

&lt;h2 id="toc_4"&gt;Keyboard control&lt;/h2&gt;

&lt;p&gt;As you&amp;#39;ll have noticed, everything is controlled through sending single-letter
commands through &lt;strong&gt;/tmp/audio_control&lt;/strong&gt;.
We could make the user echo data through this named pipe but that wouldn&amp;#39;t be very
convenient.&lt;/p&gt;

&lt;p&gt;Better to send a command when the user presses a key on the keyboard.
How you do this will depend on your environment.&lt;/p&gt;

&lt;p&gt;The window manager I use is &lt;a href="http://www.icewm.org"&gt;IceWM&lt;/a&gt;. It has a
&lt;strong&gt;$HOME/.icewm/keys&lt;/strong&gt; file where you can specify commands to run when a key
is pressed.&lt;/p&gt;

&lt;p&gt;Here&amp;#39;s my &lt;strong&gt;$HOME/.icewm/keys&lt;/strong&gt; file:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;key &amp;quot;XF86AudioRaiseVolume&amp;quot; sh -c &amp;quot;test -p /tmp/audio_control &amp;amp;&amp;amp; echo u &amp;gt; /tmp/audio_control&amp;quot;
key &amp;quot;XF86AudioLowerVolume&amp;quot; sh -c &amp;quot;test -p /tmp/audio_control &amp;amp;&amp;amp; echo d &amp;gt; /tmp/audio_control&amp;quot;
key &amp;quot;XF86AudioMute&amp;quot; sh -c &amp;quot;test -p /tmp/audio_control &amp;amp;&amp;amp; echo t &amp;gt; /tmp/audio_control&amp;quot;
key &amp;quot;F12&amp;quot; sh -c &amp;quot;test -p /tmp/audio_control &amp;amp;&amp;amp; echo m &amp;gt; /tmp/audio_control&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The volume up (&lt;strong&gt;XF86AudioRaiseVolume&lt;/strong&gt;) and down (&lt;strong&gt;XF86AudioLowerVolume&lt;/strong&gt;)
keys on the keyboard send the &lt;strong&gt;u&lt;/strong&gt; and &lt;strong&gt;d&lt;/strong&gt; commands through &lt;strong&gt;/tmp/audio_control&lt;/strong&gt; - resulting in the microphone volume being increased or decreased and
the level displayed on the screen.&lt;/p&gt;

&lt;p&gt;The mute key (&lt;strong&gt;XF86AudioMute&lt;/strong&gt;) key sends the &lt;strong&gt;t&lt;/strong&gt; command through &lt;strong&gt;/tmp/audio_control&lt;/strong&gt;, resulting in the
microphone being muted or unmuted and the status displayed on the screen.&lt;/p&gt;

&lt;p&gt;The &lt;strong&gt;F12&lt;/strong&gt; key sends the &lt;strong&gt;m&lt;/strong&gt; command through &lt;strong&gt;/tmp/audio_control&lt;/strong&gt;.
This starts displaying the current microphone level on the screen, changing
in real time as you speak into it. Press &lt;strong&gt;F12&lt;/strong&gt; again to stop monitoring the
microphone level.&lt;/p&gt;

&lt;h2 id="toc_5"&gt;Putting it all together&lt;/h2&gt;

&lt;p&gt;The complete script is &lt;a href="https://gist.github.com/3847759#file_vu_meter.sh"&gt;here&lt;/a&gt;. Remember you need to set &lt;strong&gt;ctlIn&lt;/strong&gt; and &lt;strong&gt;ctlDelta&lt;/strong&gt; for
your device at the top.
The script calls &lt;strong&gt;rkill.sh&lt;/strong&gt; from my &lt;a href="/script-cleanup"&gt;previous post&lt;/a&gt;
to clean things up at the end - press ^C or Enter to exit.&lt;/p&gt;

&lt;p&gt;Finally, here are some screenshots of my Vu Meter in action:&lt;/p&gt;

&lt;p&gt;&lt;a href="/assets/media/vu-meter/mic-on.png"&gt;&lt;img src="/assets/media/vu-meter/mic-on.png" alt="Microphone On" title="Microphone On"&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href="/assets/media/vu-meter/mic-mon.png"&gt;&lt;img src="/assets/media/vu-meter/mic-mon.png" alt="Microphone Monitor" title="Microphone Off"&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href="/assets/media/vu-meter/mic-off.png"&gt;&lt;img src="/assets/media/vu-meter/mic-off.png" alt="Microphone Off" title="Microphone Monitor"&gt;&lt;/a&gt;&lt;/p&gt;

    &lt;hr&gt;
    &lt;div class="pagination pagination-centered btn-group"&gt;
        &lt;a class="btn prev" href="/script-cleanup" title="Script Cleanup"&gt;&amp;larr; Previous&lt;/a&gt;

        &lt;a class="btn" href="/archive"&gt;Archive&lt;/a&gt;

        &lt;a class="btn next disabled"&gt;Next &amp;rarr;&lt;/a&gt;
    &lt;/div&gt;
    &lt;hr&gt;
    &lt;div id="disqus_thread"&gt;&lt;/div&gt;
&lt;script&gt;
    var disqus_developer = 1;
    var disqus_shortname = 'davedoesdev'; // required: replace example with your forum shortname
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
&lt;/script&gt;
&lt;noscript&gt;Please enable JavaScript to view the &lt;a href="http://disqus.com/?ref_noscript"&gt;comments powered by Disqus.&lt;/a&gt;&lt;/noscript&gt;
&lt;a href="http://disqus.com" class="dsq-brlink"&gt;blog comments powered by &lt;span class="logo-disqus"&gt;Disqus&lt;/span&gt;&lt;/a&gt;

  &lt;/div&gt;
  
  &lt;div class="span3"&gt;
    &lt;section&gt;
      &lt;h4&gt;Published&lt;/h4&gt;
      &lt;div class="date"&gt;&lt;span&gt;2012-10-07&lt;/span&gt;&lt;/div&gt;
    &lt;/section&gt;

    &lt;section class="tag_box_container_empty" &gt;
      &lt;h4&gt;Categories&lt;/h4&gt;
      &lt;ul class="tag_box"&gt;
      &lt;/ul&gt;
    &lt;/section&gt;

    &lt;section class="tag_box_container_empty" &gt;
      &lt;h4&gt;Tags&lt;/h4&gt;
      &lt;ul class="tag_box"&gt;
      &lt;/ul&gt;
    &lt;/section&gt;
  &lt;/div&gt;
&lt;/div&gt;

      &lt;/div&gt;

      &lt;footer&gt;
        &lt;p&gt;&amp;copy; &lt;a href="mailto:dave@davedoesdev.com"&gt;David Halls&lt;span class="icon-envelope icon-white"&gt;&lt;/span&gt;&lt;/a&gt; 2012 
          with help from &lt;a href="http://ruhoh.com" target="_self" title="The Definitive Technical Blogging Framework"&gt;ruhoh&lt;/a&gt;,
          &lt;a href="http://twitter.github.com/bootstrap/" target="_self"&gt;Twitter Bootstrap&lt;/a&gt; and
          &lt;a href="http://www.glyphicons.com"&gt;Glyphicons&lt;/a&gt;.
        &lt;/p&gt;
        &lt;p&gt;This site uses cookies for &lt;a href="http://www.getclicky.com/terms" target="_self"&gt;analytics&lt;/a&gt; and &lt;a href="http://help.disqus.com/customer/portal/articles/466259-privacy-policy" target="_self"&gt;commenting&lt;/a&gt;.&lt;/p&gt;
      &lt;/footer&gt;
    &lt;/div&gt; &lt;!-- /container --&gt;

    &lt;script&gt;
var clicky_site_ids = clicky_site_ids || [];
clicky_site_ids.push(66642016);
(function() {
  var s = document.createElement('script');
  s.type = 'text/javascript';
  s.async = true;
  s.src = '//static.getclicky.com/js';
  ( document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0] ).appendChild( s );
})();
&lt;/script&gt;
&lt;noscript&gt;&lt;p&gt;&lt;img alt="Clicky" width="1" height="1" src="//in.getclicky.com/66642016ns.gif" /&gt;&lt;/p&gt;&lt;/noscript&gt;
    &lt;!-- Google Prettify --&gt;
&lt;script src="http://cdnjs.cloudflare.com/ajax/libs/prettify/188.0.0/prettify.js"&gt;&lt;/script&gt;
&lt;script&gt;
  var pres = document.getElementsByTagName("pre");
  for (var i=0; i &lt; pres.length; ++i) {
    pres[i].className = "prettyprint ";
  }
  prettyPrint();
&lt;/script&gt;
&lt;!-- end Google Prettify --&gt;
  &lt;/body&gt;
&lt;/html&gt;
</description>
    </item>
    <item>
      <title>Script Cleanup</title>
      <link>http://www.davedoesdev.com/script-cleanup</link>
      <pubDate>2012-09-29</pubDate>
      <description>&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
  &lt;head&gt;
    &lt;meta charset="utf-8"&gt;
    &lt;title&gt;Script Cleanup - Dave Does Dev&lt;/title&gt;
    &lt;meta name="author" content="David Halls"&gt;

    &lt;!-- HTML5 shim, for IE6-8 support of HTML elements --&gt;
    &lt;!--[if lt IE 9]&gt;
      &lt;script src="http://html5shim.googlecode.com/svn/trunk/html5.js"&gt;&lt;/script&gt;
    &lt;![endif]--&gt;
    &lt;link href="/assets/my_hooligan/stylesheets/bootstrap/css/bootstrap.min.css?0.395531780257535" type="text/css" rel="stylesheet" media="all"&gt;
&lt;link href="/assets/my_hooligan/stylesheets/bootstrap/css/bootstrap-responsive.min.css?0.5413817073058964" type="text/css" rel="stylesheet" media="all"&gt;
&lt;link href="/assets/my_hooligan/stylesheets/css-social-buttons/zocial.stripped.css?0.42940072915181593" type="text/css" rel="stylesheet" media="all"&gt;
&lt;link href="/assets/my_hooligan/stylesheets/css/darkstrap.css?0.4284444056329101" type="text/css" rel="stylesheet" media="all"&gt;
&lt;link href="/assets/my_hooligan/stylesheets/css/style.css?0.24093441946470795" type="text/css" rel="stylesheet" media="all"&gt;
&lt;link href="/assets/my_hooligan/widgets/google_prettify/stylesheets/sunburst.css?0.8149305767341514" type="text/css" rel="stylesheet" media="all"&gt;

&lt;script src="/assets/my_hooligan/javascripts/jquery.min.js?0.08545700576168747"&gt;&lt;/script&gt;
&lt;script src="/assets/my_hooligan/javascripts/bootstrap.min.js?0.27584246283313374"&gt;&lt;/script&gt;
 
    
    &lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;
    &lt;link rel="shortcut icon" href="/assets/media/favicon.ico"&gt;
    &lt;!-- fav and touch icons --&gt;
  &lt;!-- Update these with your own images
    &lt;link rel="shortcut icon" href="images/favicon.ico"&gt;
    &lt;link rel="apple-touch-icon" href="images/apple-touch-icon.png"&gt;
    &lt;link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png"&gt;
    &lt;link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png"&gt;
  --&gt;
  &lt;/head&gt;

  &lt;body&gt;
    &lt;div class="navbar"&gt;
      &lt;div class="navbar-inner"&gt;
        &lt;div class="container"&gt;
          &lt;!-- .btn-navbar is used as the toggle for collapsed navbar content --&gt;
          &lt;a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse"&gt;
            &lt;span class="icon-bar"&gt;&lt;/span&gt;
            &lt;span class="icon-bar"&gt;&lt;/span&gt;
            &lt;span class="icon-bar"&gt;&lt;/span&gt;
          &lt;/a&gt;      


          &lt;a class="brand" href="/"&gt;Dave Does Dev&lt;/a&gt;


          &lt;div class="nav-collapse"&gt;
            &lt;ul class="nav"&gt;
                
                  &lt;li&gt;&lt;a href="/archive"&gt;Archive&lt;/a&gt;&lt;/li&gt;
                
                  &lt;li&gt;&lt;a href="/tags"&gt;Tags&lt;/a&gt;&lt;/li&gt;
                
                  &lt;li&gt;&lt;a href="/categories"&gt;Categories&lt;/a&gt;&lt;/li&gt;
                
                  &lt;li&gt;&lt;a href="/pages"&gt;Pages&lt;/a&gt;&lt;/li&gt;
                
                  &lt;li&gt;&lt;a href="/about"&gt;About Me&lt;/a&gt;&lt;/li&gt;
                &lt;li&gt;
                  &lt;a href="https://www.github.com/davedoesdev" class="hidden-desktop" target="_self"&gt;Github&lt;/a&gt;
                &lt;/li&gt;
                &lt;li&gt;
                  &lt;a href="http://www.twitter.com/davedoesdev" class="hidden-desktop" target="_self"&gt;Twitter&lt;/a&gt;
                &lt;/li&gt;
                &lt;li&gt;
                  &lt;a href="http://www.linkedin.com/in/dhalls" class="hidden-desktop" target="_self"&gt;LinkedIn&lt;/a&gt;
                &lt;/li&gt;
              &lt;li&gt;
                &lt;a href="/rss.xml" class="hidden-desktop" target="_self"&gt;RSS&lt;/a&gt;
              &lt;/li&gt;
            &lt;/ul&gt;
            &lt;ul class="nav pull-right social visible-desktop"&gt;
              &lt;li class="divider-vertical"&gt;&lt;/li&gt;
                &lt;li&gt;
                  &lt;a href="https://www.github.com/davedoesdev" class="zocial github icon" target="_self"&gt;
                    &lt;span class="hidden-desktop"&gt;Github&lt;/span&gt;
                  &lt;/a&gt;
                &lt;/li&gt;
                &lt;li&gt;
                  &lt;a href="http://www.twitter.com/davedoesdev" class="zocial twitter icon" target="_self"&gt;
                    &lt;span class="hidden-desktop"&gt;Twitter&lt;/span&gt;
                  &lt;/a&gt;
                &lt;/li&gt;
                &lt;li&gt;
                  &lt;a href="http://www.linkedin.com/in/dhalls" class="zocial linkedin icon" target="_self"&gt;
                    &lt;span class="hidden-desktop"&gt;LinkedIn&lt;/span&gt;
                  &lt;/a&gt;
                &lt;/li&gt;
              &lt;li&gt;
                &lt;a href="/rss.xml" class="zocial rss icon" target="_self"&gt;
                  &lt;span class="hidden-desktop"&gt;RSS&lt;/span&gt;
                &lt;/a&gt;
              &lt;/li&gt;
            &lt;/ul&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;

    &lt;div class="container"&gt;
      &lt;div class="content"&gt;
        &lt;div class="page-header"&gt;
  &lt;h1&gt;
    Script Cleanup 
  &lt;/h1&gt;
&lt;/div&gt;

&lt;div class="row"&gt;
  &lt;div class="span9"&gt;
    &lt;p&gt;Sometimes I like to write complicated &lt;a href="http://www.gnu.org/software/bash/bash.html"&gt;Bash&lt;/a&gt; scripts. You know the ones - multiple background subprocesses,
communicating through pipes or fifos. In fact, my next post will be about
one I&amp;#39;ve written recently.&lt;/p&gt;

&lt;p&gt;At the end of the script, you have to make sure all those background processes
are killed.&lt;/p&gt;

&lt;h2 id="toc_0"&gt;rkill.sh&lt;/h2&gt;

&lt;p&gt;I&amp;#39;ve pulled code to do this out into a separate file, &lt;a href="https://gist.github.com/3808428#file_rkill.sh"&gt;rkill.sh&lt;/a&gt;.
It&amp;#39;s listed below, but I&amp;#39;ve split it into sections here to make it easier to
explain.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;#!/bin/bash

function contains
{
  local arr=(&amp;quot;${!1}&amp;quot;)

  for v in &amp;quot;${arr[@]}&amp;quot;
  do
    if test &amp;quot;$v&amp;quot; = &amp;quot;$2&amp;quot;
    then
      return 0
    fi
  done

  return 1
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The &lt;strong&gt;contains&lt;/strong&gt; function returns 0 if its second argument is in the array whose
name is passed as the first argument. Otherwise it returns 1.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;function rkill
{
  local pid=$1 p d s

  done_pids=(&amp;quot;${done_pids[@]}&amp;quot; $pid)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The &lt;strong&gt;rkill&lt;/strong&gt; function is where the action happens. It takes one parameter -
the ID of the process at the root of the tree to kill (&lt;strong&gt;pid&lt;/strong&gt;). This is added
to the list of processes already dealt with so we don&amp;#39;t end up in a loop.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;  if test $pid -eq $BASHPID
  then
    return
  fi
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Don&amp;#39;t kill the process running this script!&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;  if ! contains skip[@] $pid
  then
    kill -s STOP $pid
    while true
    do
      s=$(ps -o pid,stat | grep $pid | awk &amp;#39;{print substr($NF, 0, 1)}&amp;#39;)
      if test -z &amp;quot;$s&amp;quot; -o &amp;quot;$s&amp;quot; = T
      then
        break
      fi
      sleep 1
    done
  fi
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The &lt;strong&gt;skip&lt;/strong&gt; array can contain a list of processes not to kill. If &lt;strong&gt;pid&lt;/strong&gt;
isn&amp;#39;t in this list, then suspend it so it doesn&amp;#39;t continue to create new
children. We also wait until &lt;strong&gt;ps&lt;/strong&gt; shows the process is suspended.&lt;/p&gt;

&lt;p&gt;Then, even if we skip a process, we recurse to its children:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;  while true
  do
    d=0

    for p in $(pgrep -P $pid)
    do
      if ! contains done_pids[@] $p
      then
        d=1
        rkill $p
        break
      fi
    done

    if test $d -eq 0
    then
      break
    fi
  done
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;What we do is find all the children of &lt;strong&gt;pid&lt;/strong&gt; and call &lt;strong&gt;rkill&lt;/strong&gt; on
each of them, checking we haven&amp;#39;t seen a process before recursing.&lt;/p&gt;

&lt;p&gt;We keep going until there are no child processes left that we haven&amp;#39;t seen
before.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;  if ! contains skip[@] $pid
  then
    if ! contains nokill[@] $pid
    then
      kill $pid
    fi
    kill -s CONT $pid
  fi
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Finally, if we&amp;#39;re not skipping &lt;strong&gt;pid&lt;/strong&gt; and it&amp;#39;s not in the &lt;strong&gt;nokill&lt;/strong&gt; array
then we kill it. We need to resume the process even after killing it so it can
die.&lt;/p&gt;

&lt;p&gt;Note that &lt;strong&gt;nokill&lt;/strong&gt; is slightly different to &lt;strong&gt;skip&lt;/strong&gt;. A &lt;strong&gt;nokill&lt;/strong&gt; process
is suspended while its children are killed; a &lt;strong&gt;skip&lt;/strong&gt; process is not.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;for arg in &amp;quot;$@&amp;quot;
do
  case $arg in
    --skip=*) skip=(&amp;quot;${skip[@]}&amp;quot; $(echo &amp;quot;$arg&amp;quot; | sed &amp;#39;s/^.*=//&amp;#39;));;
    --nokill=*) nokill=(&amp;quot;${nokill[@]} $(echo &amp;quot;$arg&amp;quot; | sed &amp;#39;s/^.*=//&amp;#39;)&amp;quot;);;
    *) pid=&amp;quot;$arg&amp;quot;;;
  esac
done  
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This is a simple command line parser which accumulates &lt;strong&gt;skip&lt;/strong&gt; and &lt;strong&gt;nokill&lt;/strong&gt;
process IDs. Any other argument is assumed to be the process ID at the root
of the tree to kill.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;if test $pid
then
  rkill $pid
fi
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Finally, we kick things off by calling &lt;strong&gt;rkill&lt;/strong&gt; with the process ID passed on
the command line.&lt;/p&gt;

&lt;h2 id="toc_1"&gt;Example&lt;/h2&gt;

&lt;p&gt;To check it works, put &lt;strong&gt;rkill.sh&lt;/strong&gt; somewhere on your path and run something
like this:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;#!/bin/bash

( echo 12; sleep 20; echo 54;
  ( ls; ls ) &amp;gt; /dev/null &amp;amp;
  ( sleep 30; (echo foo) ) &amp;amp;
  echo 90
) | (
  read x
  rkill.sh --skip=$BASHPID $$
  echo finished
)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This script should suspend and then terminate without leaving any new processes
behind. It&amp;#39;ll display &lt;strong&gt;finished&lt;/strong&gt; after killing all subprocesses - any extra
cleanup can be done after &lt;strong&gt;rkill.sh&lt;/strong&gt; returns.&lt;/p&gt;

    &lt;hr&gt;
    &lt;div class="pagination pagination-centered btn-group"&gt;
        &lt;a class="btn prev" href="/old-skool-splash-screen" title="Old Skool Splash Screen"&gt;&amp;larr; Previous&lt;/a&gt;

        &lt;a class="btn" href="/archive"&gt;Archive&lt;/a&gt;

        &lt;a class="btn next" href="/vu-meter" title="Vu Meter"&gt;Next &amp;rarr;&lt;/a&gt;
    &lt;/div&gt;
    &lt;hr&gt;
    &lt;div id="disqus_thread"&gt;&lt;/div&gt;
&lt;script&gt;
    var disqus_developer = 1;
    var disqus_shortname = 'davedoesdev'; // required: replace example with your forum shortname
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
&lt;/script&gt;
&lt;noscript&gt;Please enable JavaScript to view the &lt;a href="http://disqus.com/?ref_noscript"&gt;comments powered by Disqus.&lt;/a&gt;&lt;/noscript&gt;
&lt;a href="http://disqus.com" class="dsq-brlink"&gt;blog comments powered by &lt;span class="logo-disqus"&gt;Disqus&lt;/span&gt;&lt;/a&gt;

  &lt;/div&gt;
  
  &lt;div class="span3"&gt;
    &lt;section&gt;
      &lt;h4&gt;Published&lt;/h4&gt;
      &lt;div class="date"&gt;&lt;span&gt;2012-09-29&lt;/span&gt;&lt;/div&gt;
    &lt;/section&gt;

    &lt;section class="tag_box_container_empty" &gt;
      &lt;h4&gt;Categories&lt;/h4&gt;
      &lt;ul class="tag_box"&gt;
      &lt;/ul&gt;
    &lt;/section&gt;

    &lt;section class="tag_box_container" &gt;
      &lt;h4&gt;Tags&lt;/h4&gt;
      &lt;ul class="tag_box"&gt;
          &lt;li&gt;
            &lt;a href="/tags#script-ref"&gt;script &lt;span&gt;1&lt;/span&gt;&lt;/a&gt;
          &lt;/li&gt;          &lt;li&gt;
            &lt;a href="/tags#linux-ref"&gt;linux &lt;span&gt;1&lt;/span&gt;&lt;/a&gt;
          &lt;/li&gt;          &lt;li&gt;
            &lt;a href="/tags#bash-ref"&gt;bash &lt;span&gt;1&lt;/span&gt;&lt;/a&gt;
          &lt;/li&gt;      &lt;/ul&gt;
    &lt;/section&gt;
  &lt;/div&gt;
&lt;/div&gt;

      &lt;/div&gt;

      &lt;footer&gt;
        &lt;p&gt;&amp;copy; &lt;a href="mailto:dave@davedoesdev.com"&gt;David Halls&lt;span class="icon-envelope icon-white"&gt;&lt;/span&gt;&lt;/a&gt; 2012 
          with help from &lt;a href="http://ruhoh.com" target="_self" title="The Definitive Technical Blogging Framework"&gt;ruhoh&lt;/a&gt;,
          &lt;a href="http://twitter.github.com/bootstrap/" target="_self"&gt;Twitter Bootstrap&lt;/a&gt; and
          &lt;a href="http://www.glyphicons.com"&gt;Glyphicons&lt;/a&gt;.
        &lt;/p&gt;
        &lt;p&gt;This site uses cookies for &lt;a href="http://www.getclicky.com/terms" target="_self"&gt;analytics&lt;/a&gt; and &lt;a href="http://help.disqus.com/customer/portal/articles/466259-privacy-policy" target="_self"&gt;commenting&lt;/a&gt;.&lt;/p&gt;
      &lt;/footer&gt;
    &lt;/div&gt; &lt;!-- /container --&gt;

    &lt;script&gt;
var clicky_site_ids = clicky_site_ids || [];
clicky_site_ids.push(66642016);
(function() {
  var s = document.createElement('script');
  s.type = 'text/javascript';
  s.async = true;
  s.src = '//static.getclicky.com/js';
  ( document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0] ).appendChild( s );
})();
&lt;/script&gt;
&lt;noscript&gt;&lt;p&gt;&lt;img alt="Clicky" width="1" height="1" src="//in.getclicky.com/66642016ns.gif" /&gt;&lt;/p&gt;&lt;/noscript&gt;
    &lt;!-- Google Prettify --&gt;
&lt;script src="http://cdnjs.cloudflare.com/ajax/libs/prettify/188.0.0/prettify.js"&gt;&lt;/script&gt;
&lt;script&gt;
  var pres = document.getElementsByTagName("pre");
  for (var i=0; i &lt; pres.length; ++i) {
    pres[i].className = "prettyprint ";
  }
  prettyPrint();
&lt;/script&gt;
&lt;!-- end Google Prettify --&gt;
  &lt;/body&gt;
&lt;/html&gt;
</description>
    </item>
    <item>
      <title>Old Skool Splash Screen</title>
      <link>http://www.davedoesdev.com/old-skool-splash-screen</link>
      <pubDate>2012-09-22</pubDate>
      <description>&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
  &lt;head&gt;
    &lt;meta charset="utf-8"&gt;
    &lt;title&gt;Old Skool Splash Screen - Dave Does Dev&lt;/title&gt;
    &lt;meta name="author" content="David Halls"&gt;

    &lt;!-- HTML5 shim, for IE6-8 support of HTML elements --&gt;
    &lt;!--[if lt IE 9]&gt;
      &lt;script src="http://html5shim.googlecode.com/svn/trunk/html5.js"&gt;&lt;/script&gt;
    &lt;![endif]--&gt;
    &lt;link href="/assets/my_hooligan/stylesheets/bootstrap/css/bootstrap.min.css?0.8069786886512532" type="text/css" rel="stylesheet" media="all"&gt;
&lt;link href="/assets/my_hooligan/stylesheets/bootstrap/css/bootstrap-responsive.min.css?0.5634776759930075" type="text/css" rel="stylesheet" media="all"&gt;
&lt;link href="/assets/my_hooligan/stylesheets/css-social-buttons/zocial.stripped.css?0.9539240011880273" type="text/css" rel="stylesheet" media="all"&gt;
&lt;link href="/assets/my_hooligan/stylesheets/css/darkstrap.css?0.21917639507418119" type="text/css" rel="stylesheet" media="all"&gt;
&lt;link href="/assets/my_hooligan/stylesheets/css/style.css?0.8194171275521377" type="text/css" rel="stylesheet" media="all"&gt;
&lt;link href="/assets/my_hooligan/widgets/google_prettify/stylesheets/sunburst.css?0.6344099770442662" type="text/css" rel="stylesheet" media="all"&gt;

&lt;script src="/assets/my_hooligan/javascripts/jquery.min.js?0.0761527037529568"&gt;&lt;/script&gt;
&lt;script src="/assets/my_hooligan/javascripts/bootstrap.min.js?0.025876132672522867"&gt;&lt;/script&gt;
 
    
    &lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;
    &lt;link rel="shortcut icon" href="/assets/media/favicon.ico"&gt;
    &lt;!-- fav and touch icons --&gt;
  &lt;!-- Update these with your own images
    &lt;link rel="shortcut icon" href="images/favicon.ico"&gt;
    &lt;link rel="apple-touch-icon" href="images/apple-touch-icon.png"&gt;
    &lt;link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png"&gt;
    &lt;link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png"&gt;
  --&gt;
  &lt;/head&gt;

  &lt;body&gt;
    &lt;div class="navbar"&gt;
      &lt;div class="navbar-inner"&gt;
        &lt;div class="container"&gt;
          &lt;!-- .btn-navbar is used as the toggle for collapsed navbar content --&gt;
          &lt;a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse"&gt;
            &lt;span class="icon-bar"&gt;&lt;/span&gt;
            &lt;span class="icon-bar"&gt;&lt;/span&gt;
            &lt;span class="icon-bar"&gt;&lt;/span&gt;
          &lt;/a&gt;      


          &lt;a class="brand" href="/"&gt;Dave Does Dev&lt;/a&gt;


          &lt;div class="nav-collapse"&gt;
            &lt;ul class="nav"&gt;
                
                  &lt;li&gt;&lt;a href="/archive"&gt;Archive&lt;/a&gt;&lt;/li&gt;
                
                  &lt;li&gt;&lt;a href="/tags"&gt;Tags&lt;/a&gt;&lt;/li&gt;
                
                  &lt;li&gt;&lt;a href="/categories"&gt;Categories&lt;/a&gt;&lt;/li&gt;
                
                  &lt;li&gt;&lt;a href="/pages"&gt;Pages&lt;/a&gt;&lt;/li&gt;
                
                  &lt;li&gt;&lt;a href="/about"&gt;About Me&lt;/a&gt;&lt;/li&gt;
                &lt;li&gt;
                  &lt;a href="https://www.github.com/davedoesdev" class="hidden-desktop" target="_self"&gt;Github&lt;/a&gt;
                &lt;/li&gt;
                &lt;li&gt;
                  &lt;a href="http://www.twitter.com/davedoesdev" class="hidden-desktop" target="_self"&gt;Twitter&lt;/a&gt;
                &lt;/li&gt;
                &lt;li&gt;
                  &lt;a href="http://www.linkedin.com/in/dhalls" class="hidden-desktop" target="_self"&gt;LinkedIn&lt;/a&gt;
                &lt;/li&gt;
              &lt;li&gt;
                &lt;a href="/rss.xml" class="hidden-desktop" target="_self"&gt;RSS&lt;/a&gt;
              &lt;/li&gt;
            &lt;/ul&gt;
            &lt;ul class="nav pull-right social visible-desktop"&gt;
              &lt;li class="divider-vertical"&gt;&lt;/li&gt;
                &lt;li&gt;
                  &lt;a href="https://www.github.com/davedoesdev" class="zocial github icon" target="_self"&gt;
                    &lt;span class="hidden-desktop"&gt;Github&lt;/span&gt;
                  &lt;/a&gt;
                &lt;/li&gt;
                &lt;li&gt;
                  &lt;a href="http://www.twitter.com/davedoesdev" class="zocial twitter icon" target="_self"&gt;
                    &lt;span class="hidden-desktop"&gt;Twitter&lt;/span&gt;
                  &lt;/a&gt;
                &lt;/li&gt;
                &lt;li&gt;
                  &lt;a href="http://www.linkedin.com/in/dhalls" class="zocial linkedin icon" target="_self"&gt;
                    &lt;span class="hidden-desktop"&gt;LinkedIn&lt;/span&gt;
                  &lt;/a&gt;
                &lt;/li&gt;
              &lt;li&gt;
                &lt;a href="/rss.xml" class="zocial rss icon" target="_self"&gt;
                  &lt;span class="hidden-desktop"&gt;RSS&lt;/span&gt;
                &lt;/a&gt;
              &lt;/li&gt;
            &lt;/ul&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;

    &lt;div class="container"&gt;
      &lt;div class="content"&gt;
        &lt;div class="page-header"&gt;
  &lt;h1&gt;
    Old Skool Splash Screen 
  &lt;/h1&gt;
&lt;/div&gt;

&lt;div class="row"&gt;
  &lt;div class="span9"&gt;
    &lt;p&gt;After I &lt;a href="/quieter-boot"&gt;got rid of most boot messages&lt;/a&gt;, I wanted to display a
splash screen.&lt;/p&gt;

&lt;p&gt;&lt;a href="http://www.syslinux.org"&gt;Syslinux&lt;/a&gt; can show a splash screen but it doesn&amp;#39;t stay around until X starts.
I could have taken the easy route and put &lt;a href="https://launchpad.net/usplash"&gt;Usplash&lt;/a&gt;
or &lt;a href="http://alioth.debian.org/projects/splashy/"&gt;Splashy&lt;/a&gt; into &lt;a href="http://distro.ibiblio.org/tinycorelinux/"&gt;Tiny Core Linux&lt;/a&gt;
on my USB stick.&lt;/p&gt;

&lt;p&gt;But no! I took another route. I used
&lt;a href="http://www.svgalib.org/rus/zgv/"&gt;Zgv&lt;/a&gt;. Zgv is an &lt;a href="http://www.svgalib.org"&gt;SVGAlib&lt;/a&gt;-based image viewer,
so it runs on the Linux console. Feed it an image early on in the Tiny
Core &lt;strong&gt;init.d&lt;/strong&gt; scripts and voila, a splash screen!&lt;/p&gt;

&lt;h2 id="toc_0"&gt;SVGALib&lt;/h2&gt;

&lt;p&gt;It wasn&amp;#39;t all plain sailing though. The first thing was to get SVGAlib compiling
on a modern Linux distribution (let&amp;#39;s assume Ubuntu here). Of course, I had
to make some &lt;a href="https://gist.github.com/3764135#file_svgalib_1.4.3.patch"&gt;patches&lt;/a&gt;. There wasn&amp;#39;t much to
fix:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;Only build static libraries. I didn&amp;#39;t need to use SVGAlib with anything else
on Tiny Core Linux.&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Don&amp;#39;t bother with assembly optimizations.&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Various type, macro and syntax changes - probably due to a tightening-up of
compiler rules.&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id="toc_1"&gt;Zgv&lt;/h2&gt;

&lt;p&gt;I also &lt;a href="https://gist.github.com/3767626#file_zgv_5.9.patch"&gt;patched&lt;/a&gt; Zgv - not to fix compile errors, but to:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;Support &lt;a href="http://www.syslinux.org/wiki/index.php/SYSLINUX#Display_graphic_from_filename:"&gt;LSS16&lt;/a&gt;
image files. LSS16 is an arbitrary format which Syslinux supports for
displaying splash screens. I wanted to use the same files in Syslinux later
on if I wanted to.&lt;/p&gt;

&lt;p&gt;I implemented the main logic for loading LSS16
images as separate &lt;a href="https://gist.github.com/3767626#file_readlss16.c"&gt;source&lt;/a&gt;
and &lt;a href="https://gist.github.com/3767626#file_readlss16.h"&gt;header&lt;/a&gt; files.&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Remove support for JPEG, PNG and TIFF images in Zgv. I didn&amp;#39;t need these
libraries so it was pointless to add them to Tiny Core Linux and load them
from the USB stick.&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Add support for 640 x 480 x 16 colours &lt;a href="http://en.wikipedia.org/wiki/Planar_(computer_graphics)"&gt;planar&lt;/a&gt; VGA mode. &lt;/p&gt;

&lt;p&gt;SVGALib&amp;#39;s &lt;strong&gt;vga_getmodeinfo&lt;/strong&gt; returns 0 bytes per pixel for planar VGA modes.
For my graphics adapter it was only returning one 640 x 480 mode, and it was
planar.&lt;/p&gt;

&lt;p&gt;Since I was only going to be using this mode for 640 x 480, I made a hack
and changed only the graphics mode selection algorithm. From the patch:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;+  if(bpp==4) bytepp=0; else bytepp=(bpp+7)/8;&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Don&amp;#39;t dither LSS16 images to 16 colours! In 16 colour mode, Zgv dithers
images, even if they have 16 colours or less. It defines its own palette
and maps the image onto it. Obviously, it&amp;#39;s better to use the 16 colours in
the image itself.&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Fix a SEGV, caused by not setting a global (&lt;strong&gt;image_palette&lt;/strong&gt;).&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id="toc_2"&gt;Making LSS16 files&lt;/h2&gt;

&lt;p&gt;I created my splash screen in &lt;a href="http://inkscape.org"&gt;Inkscape&lt;/a&gt; as a vector
graphic, &lt;strong&gt;splash.svg&lt;/strong&gt;. Here&amp;#39;s the script I used for creating a LSS16 file,
&lt;strong&gt;splash.rle&lt;/strong&gt;, from it:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;inkscape -e splash-pic.png -w 300 -h 300 -b &amp;#39;#000000&amp;#39; splash.svg
convert splash-pic.png \
        -bordercolor &amp;#39;#000000&amp;#39; \
        -border 170x40 \
        -gravity north \
        -background &amp;#39;#000000&amp;#39; \
        -extend 640x480 \
        -gravity south \
        -fill &amp;#39;#ffffff&amp;#39; \
        -pointsize 30 \
        -annotate +0+50 &amp;#39;Almost there, just a few moments...&amp;#39; \
        splash.png
convert splash.png -colors 16 splash.ppm
ppmtolss16 &amp;#39;#000000=0&amp;#39; &amp;#39;#ffffff=7&amp;#39; &amp;lt; splash.ppm &amp;gt; splash.rle
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;In other words:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;&lt;p&gt;Export the file from Inkscape, 300 x 300 on black background.&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Use &lt;a href="http://www.imagemagick.org"&gt;ImageMagick&lt;/a&gt; to:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;Add a border around the image - 40px of space at the top and extending
the width to 640px by adding 170px either side.&lt;/li&gt;
&lt;li&gt;Extend the height of the image to 480px.&lt;/li&gt;
&lt;li&gt;Add a message 50px from the bottom of the image.&lt;/li&gt;
&lt;/ol&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Use ImageMagick to convert the image to 16 color PPM format.&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Use &lt;strong&gt;ppmtolss16&lt;/strong&gt; to convert the PPM image to LSS16 format. &lt;strong&gt;ppmtolss16&lt;/strong&gt; comes with Syslinux. 
The &lt;strong&gt;.rle&lt;/strong&gt; extension because LSS16 uses run-length encoding compression.&lt;/p&gt;

&lt;p&gt;Note how I set the background colour to index 0 and the foreground color to
index 7. Zgv doesn&amp;#39;t treat these indices as special, but Syslinux sets the
console&amp;#39;s text foreground and background to the colours at these indices.&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;

&lt;h2 id="toc_3"&gt;Displaying the Splash Screen in Tiny Core&lt;/h2&gt;

&lt;p&gt;Finally, we need to call Zgv to display the image while Tiny Core Linux is
loading. I do this by putting the following at the start of
&lt;strong&gt;/etc/init.d/tc-config&lt;/strong&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[ -f /proc/cmdline ] || /bin/mount /proc
if grep -q quiet /proc/cmdline
then
  echo -en &amp;quot;\033[2J\033[1;1H&amp;quot;
  exec &amp;gt; /dev/null
  if ! ps -o comm | grep zgv
  then
    sh -c &amp;quot;zgv -p -m \&amp;quot;640 480 4\&amp;quot; --viewer-16col-colour /usr/share/splash.rle &amp;amp;&amp;quot;
  fi
fi
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This clears the screen, homes the cursor, redirects output from the
script to &lt;strong&gt;/dev/null&lt;/strong&gt; and then runs Zgv. &lt;strong&gt;-p&lt;/strong&gt; hides the loading progress
bar. &lt;strong&gt;-m&lt;/strong&gt; selects the display mode to 640 x 480 x 4 bits per pixel.
&lt;strong&gt;--viewer-16col-colour&lt;/strong&gt; seems a bit superfluous given that it knows there
are 4 bits per pixel, but Zgv needs it anyway.&lt;/p&gt;

&lt;p&gt;To stop Zgv before X loads, I put the following at the end of
&lt;strong&gt;/etc/init.d/tc-config&lt;/strong&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;if grep -q quiet /proc/cmdline
then
  sudo killall -INT zgv
  while ps -o comm | grep zgv; do sleep 1; done
fi
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Note I only run Zgv if &lt;strong&gt;quiet&lt;/strong&gt; was passed as a kernel boot parameter.&lt;/p&gt;

&lt;p&gt;You might want to &lt;a href="http://wiki.tinycorelinux.net/wiki:remastering"&gt;remaster&lt;/a&gt;
your Tiny Core image to put these changes in.&lt;/p&gt;

    &lt;hr&gt;
    &lt;div class="pagination pagination-centered btn-group"&gt;
        &lt;a class="btn prev" href="/quieter-boot" title="Quieter Boot"&gt;&amp;larr; Previous&lt;/a&gt;

        &lt;a class="btn" href="/archive"&gt;Archive&lt;/a&gt;

        &lt;a class="btn next" href="/script-cleanup" title="Script Cleanup"&gt;Next &amp;rarr;&lt;/a&gt;
    &lt;/div&gt;
    &lt;hr&gt;
    &lt;div id="disqus_thread"&gt;&lt;/div&gt;
&lt;script&gt;
    var disqus_developer = 1;
    var disqus_shortname = 'davedoesdev'; // required: replace example with your forum shortname
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
&lt;/script&gt;
&lt;noscript&gt;Please enable JavaScript to view the &lt;a href="http://disqus.com/?ref_noscript"&gt;comments powered by Disqus.&lt;/a&gt;&lt;/noscript&gt;
&lt;a href="http://disqus.com" class="dsq-brlink"&gt;blog comments powered by &lt;span class="logo-disqus"&gt;Disqus&lt;/span&gt;&lt;/a&gt;

  &lt;/div&gt;
  
  &lt;div class="span3"&gt;
    &lt;section&gt;
      &lt;h4&gt;Published&lt;/h4&gt;
      &lt;div class="date"&gt;&lt;span&gt;2012-09-22&lt;/span&gt;&lt;/div&gt;
    &lt;/section&gt;

    &lt;section class="tag_box_container_empty" &gt;
      &lt;h4&gt;Categories&lt;/h4&gt;
      &lt;ul class="tag_box"&gt;
      &lt;/ul&gt;
    &lt;/section&gt;

    &lt;section class="tag_box_container" &gt;
      &lt;h4&gt;Tags&lt;/h4&gt;
      &lt;ul class="tag_box"&gt;
          &lt;li&gt;
            &lt;a href="/tags#boot-ref"&gt;boot &lt;span&gt;2&lt;/span&gt;&lt;/a&gt;
          &lt;/li&gt;          &lt;li&gt;
            &lt;a href="/tags#svgalib-ref"&gt;svgalib &lt;span&gt;1&lt;/span&gt;&lt;/a&gt;
          &lt;/li&gt;          &lt;li&gt;
            &lt;a href="/tags#graphics-ref"&gt;graphics &lt;span&gt;1&lt;/span&gt;&lt;/a&gt;
          &lt;/li&gt;          &lt;li&gt;
            &lt;a href="/tags#tinycorelinux-ref"&gt;tinycorelinux &lt;span&gt;2&lt;/span&gt;&lt;/a&gt;
          &lt;/li&gt;      &lt;/ul&gt;
    &lt;/section&gt;
  &lt;/div&gt;
&lt;/div&gt;

      &lt;/div&gt;

      &lt;footer&gt;
        &lt;p&gt;&amp;copy; &lt;a href="mailto:dave@davedoesdev.com"&gt;David Halls&lt;span class="icon-envelope icon-white"&gt;&lt;/span&gt;&lt;/a&gt; 2012 
          with help from &lt;a href="http://ruhoh.com" target="_self" title="The Definitive Technical Blogging Framework"&gt;ruhoh&lt;/a&gt;,
          &lt;a href="http://twitter.github.com/bootstrap/" target="_self"&gt;Twitter Bootstrap&lt;/a&gt; and
          &lt;a href="http://www.glyphicons.com"&gt;Glyphicons&lt;/a&gt;.
        &lt;/p&gt;
        &lt;p&gt;This site uses cookies for &lt;a href="http://www.getclicky.com/terms" target="_self"&gt;analytics&lt;/a&gt; and &lt;a href="http://help.disqus.com/customer/portal/articles/466259-privacy-policy" target="_self"&gt;commenting&lt;/a&gt;.&lt;/p&gt;
      &lt;/footer&gt;
    &lt;/div&gt; &lt;!-- /container --&gt;

    &lt;script&gt;
var clicky_site_ids = clicky_site_ids || [];
clicky_site_ids.push(66642016);
(function() {
  var s = document.createElement('script');
  s.type = 'text/javascript';
  s.async = true;
  s.src = '//static.getclicky.com/js';
  ( document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0] ).appendChild( s );
})();
&lt;/script&gt;
&lt;noscript&gt;&lt;p&gt;&lt;img alt="Clicky" width="1" height="1" src="//in.getclicky.com/66642016ns.gif" /&gt;&lt;/p&gt;&lt;/noscript&gt;
    &lt;!-- Google Prettify --&gt;
&lt;script src="http://cdnjs.cloudflare.com/ajax/libs/prettify/188.0.0/prettify.js"&gt;&lt;/script&gt;
&lt;script&gt;
  var pres = document.getElementsByTagName("pre");
  for (var i=0; i &lt; pres.length; ++i) {
    pres[i].className = "prettyprint ";
  }
  prettyPrint();
&lt;/script&gt;
&lt;!-- end Google Prettify --&gt;
  &lt;/body&gt;
&lt;/html&gt;
</description>
    </item>
    <item>
      <title>Quieter Boot</title>
      <link>http://www.davedoesdev.com/quieter-boot</link>
      <pubDate>2012-09-16</pubDate>
      <description>&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
  &lt;head&gt;
    &lt;meta charset="utf-8"&gt;
    &lt;title&gt;Quieter Boot - Dave Does Dev&lt;/title&gt;
    &lt;meta name="author" content="David Halls"&gt;

    &lt;!-- HTML5 shim, for IE6-8 support of HTML elements --&gt;
    &lt;!--[if lt IE 9]&gt;
      &lt;script src="http://html5shim.googlecode.com/svn/trunk/html5.js"&gt;&lt;/script&gt;
    &lt;![endif]--&gt;
    &lt;link href="/assets/my_hooligan/stylesheets/bootstrap/css/bootstrap.min.css?0.7239154167390999" type="text/css" rel="stylesheet" media="all"&gt;
&lt;link href="/assets/my_hooligan/stylesheets/bootstrap/css/bootstrap-responsive.min.css?0.14152092204701971" type="text/css" rel="stylesheet" media="all"&gt;
&lt;link href="/assets/my_hooligan/stylesheets/css-social-buttons/zocial.stripped.css?0.5396795830933675" type="text/css" rel="stylesheet" media="all"&gt;
&lt;link href="/assets/my_hooligan/stylesheets/css/darkstrap.css?0.016533372290676418" type="text/css" rel="stylesheet" media="all"&gt;
&lt;link href="/assets/my_hooligan/stylesheets/css/style.css?0.7926302558270132" type="text/css" rel="stylesheet" media="all"&gt;
&lt;link href="/assets/my_hooligan/widgets/google_prettify/stylesheets/sunburst.css?0.013296699532711953" type="text/css" rel="stylesheet" media="all"&gt;

&lt;script src="/assets/my_hooligan/javascripts/jquery.min.js?0.19451962043884918"&gt;&lt;/script&gt;
&lt;script src="/assets/my_hooligan/javascripts/bootstrap.min.js?0.46949573995876936"&gt;&lt;/script&gt;
 
    
    &lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;
    &lt;link rel="shortcut icon" href="/assets/media/favicon.ico"&gt;
    &lt;!-- fav and touch icons --&gt;
  &lt;!-- Update these with your own images
    &lt;link rel="shortcut icon" href="images/favicon.ico"&gt;
    &lt;link rel="apple-touch-icon" href="images/apple-touch-icon.png"&gt;
    &lt;link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png"&gt;
    &lt;link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png"&gt;
  --&gt;
  &lt;/head&gt;

  &lt;body&gt;
    &lt;div class="navbar"&gt;
      &lt;div class="navbar-inner"&gt;
        &lt;div class="container"&gt;
          &lt;!-- .btn-navbar is used as the toggle for collapsed navbar content --&gt;
          &lt;a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse"&gt;
            &lt;span class="icon-bar"&gt;&lt;/span&gt;
            &lt;span class="icon-bar"&gt;&lt;/span&gt;
            &lt;span class="icon-bar"&gt;&lt;/span&gt;
          &lt;/a&gt;      


          &lt;a class="brand" href="/"&gt;Dave Does Dev&lt;/a&gt;


          &lt;div class="nav-collapse"&gt;
            &lt;ul class="nav"&gt;
                
                  &lt;li&gt;&lt;a href="/archive"&gt;Archive&lt;/a&gt;&lt;/li&gt;
                
                  &lt;li&gt;&lt;a href="/tags"&gt;Tags&lt;/a&gt;&lt;/li&gt;
                
                  &lt;li&gt;&lt;a href="/categories"&gt;Categories&lt;/a&gt;&lt;/li&gt;
                
                  &lt;li&gt;&lt;a href="/pages"&gt;Pages&lt;/a&gt;&lt;/li&gt;
                
                  &lt;li&gt;&lt;a href="/about"&gt;About Me&lt;/a&gt;&lt;/li&gt;
                &lt;li&gt;
                  &lt;a href="https://www.github.com/davedoesdev" class="hidden-desktop" target="_self"&gt;Github&lt;/a&gt;
                &lt;/li&gt;
                &lt;li&gt;
                  &lt;a href="http://www.twitter.com/davedoesdev" class="hidden-desktop" target="_self"&gt;Twitter&lt;/a&gt;
                &lt;/li&gt;
                &lt;li&gt;
                  &lt;a href="http://www.linkedin.com/in/dhalls" class="hidden-desktop" target="_self"&gt;LinkedIn&lt;/a&gt;
                &lt;/li&gt;
              &lt;li&gt;
                &lt;a href="/rss.xml" class="hidden-desktop" target="_self"&gt;RSS&lt;/a&gt;
              &lt;/li&gt;
            &lt;/ul&gt;
            &lt;ul class="nav pull-right social visible-desktop"&gt;
              &lt;li class="divider-vertical"&gt;&lt;/li&gt;
                &lt;li&gt;
                  &lt;a href="https://www.github.com/davedoesdev" class="zocial github icon" target="_self"&gt;
                    &lt;span class="hidden-desktop"&gt;Github&lt;/span&gt;
                  &lt;/a&gt;
                &lt;/li&gt;
                &lt;li&gt;
                  &lt;a href="http://www.twitter.com/davedoesdev" class="zocial twitter icon" target="_self"&gt;
                    &lt;span class="hidden-desktop"&gt;Twitter&lt;/span&gt;
                  &lt;/a&gt;
                &lt;/li&gt;
                &lt;li&gt;
                  &lt;a href="http://www.linkedin.com/in/dhalls" class="zocial linkedin icon" target="_self"&gt;
                    &lt;span class="hidden-desktop"&gt;LinkedIn&lt;/span&gt;
                  &lt;/a&gt;
                &lt;/li&gt;
              &lt;li&gt;
                &lt;a href="/rss.xml" class="zocial rss icon" target="_self"&gt;
                  &lt;span class="hidden-desktop"&gt;RSS&lt;/span&gt;
                &lt;/a&gt;
              &lt;/li&gt;
            &lt;/ul&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;

    &lt;div class="container"&gt;
      &lt;div class="content"&gt;
        &lt;div class="page-header"&gt;
  &lt;h1&gt;
    Quieter Boot 
  &lt;/h1&gt;
&lt;/div&gt;

&lt;div class="row"&gt;
  &lt;div class="span9"&gt;
    &lt;p&gt;One of my PCs has a rather unique boot sequence:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;&lt;p&gt;&lt;a href="http://www.syslinux.org"&gt;Syslinux&lt;/a&gt;, from an SD card and configured to chain
load the next stage.&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;A pre-boot environment, &lt;a href="http://www.freedos.org"&gt;FreeDOS&lt;/a&gt;, from the SD card.
The pre-boot environment does the following:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;Check if a USB stick is inserted. If there is one inserted, then continue
to the next stage in the boot sequence. Otherwise...&lt;/li&gt;
&lt;li&gt;Display a message asking the user to insert the USB stick.&lt;/li&gt;
&lt;li&gt;Wait 20 seconds for the USB stick to be inserted.&lt;/li&gt;
&lt;li&gt;If the USB stick is inserted within those 20 seconds, then continue to
the next stage in the boot sequence, but pass a flag indicating to boot
into a maintenance mode. Otherwise...&lt;/li&gt;
&lt;li&gt;Go to a DOS prompt.&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;FreeDOS makes a great pre-boot environment - it&amp;#39;s super fast to boot, very
small and you don&amp;#39;t have to faff about producing custom initrds. I used
&lt;a href="http://bretjohnson.us"&gt;Bret Johnson&lt;/a&gt;&amp;#39;s USBDOS drivers to do the USB stick
detection.&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;a href="http://www.solemnwarning.net/kexec-loader/"&gt;kexec-loader&lt;/a&gt;, from the SD card
(via &lt;a href="http://busybox.net/%7Evda/linld/"&gt;Linld&lt;/a&gt;) and configured to boot the next
stage from the USB stick. I used kexec-loader here because it contains
USB 2.0 drivers, so loading the next stage is much faster than using the
BIOS&amp;#39;s legacy emulation mode.&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;The fantastic &lt;a href="http://distro.ibiblio.org/tinycorelinux/welcome.html"&gt;Tiny Core Linux&lt;/a&gt;,
from the USB stick, booting into X with some custom extensions.&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;Now, this all works well but I wanted to reduce the copious level of noise
(messages) displayed while booting to a minimum.&lt;/p&gt;

&lt;h2 id="toc_0"&gt;Syslinux&lt;/h2&gt;

&lt;p&gt;Syslinux itself makes some noise. I had to &lt;a href="https://gist.github.com/3748363#file_syslinux_4.03.patch"&gt;patch&lt;/a&gt; it to make it quiet. You can see the patch is mostly about supressing
&lt;strong&gt;puts&lt;/strong&gt; and &lt;strong&gt;printf&lt;/strong&gt;. You can also see that the copyright notice is still
displayed.&lt;/p&gt;

&lt;p&gt;I also added some new control codes to Syslinux display files:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;STX&lt;/strong&gt; (\002): Home the cursor without clearing the screen.
I found this useful if I displayed a message in the centre of the screen.
Any text that was displayed afterwards was less likely to cause the screen
to scroll.&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;SOH&lt;/strong&gt; (\001): Hide the cursor.
Useful for a completely black screen.&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;ETX&lt;/strong&gt; (\003): Change palette register 1 (normally blue) to bright white,
using &lt;a href="http://webpages.charter.net/danrollins/techhelp/0137.HTM"&gt;INT 10H 1000H&lt;/a&gt;.&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;In the end I used just &lt;strong&gt;ETX&lt;/strong&gt; in my Syslinux display file.&lt;/p&gt;

&lt;h2 id="toc_1"&gt;FreeDOS&lt;/h2&gt;

&lt;p&gt;Confession: I didn&amp;#39;t bother supressing messages in FreeDOS. Therefore, the
FreeDOS copyright notice was displayed momentarily until the next stage.
If you want to remove this notice, you&amp;#39;ll have to patch FreeDOS and recompile
from source.&lt;/p&gt;

&lt;p&gt;I did use &lt;a href="http://help.fdos.org/en/hhstndrd/base/nansi.htm"&gt;nansi.sys&lt;/a&gt;
to display a greeting message in blue before starting kexec-loader with Linld:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;echo ESC[34mWelcome!ESC[0m
linld image=vmlinux initrd=initrd.img ...
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;(Note: you&amp;#39;ll need to get the literal ESC character into your bat file,
e.g. using ^V in Vim and then pressing the Escape key).&lt;/p&gt;

&lt;p&gt;Of course, since we used &lt;strong&gt;ETX&lt;/strong&gt; in the Syslinux display file, this message
was actually shown in bright white.&lt;/p&gt;

&lt;h2 id="toc_2"&gt;kexec-loader&lt;/h2&gt;

&lt;p&gt;To hide all further messages until X starts, I passed the following kernel
parameters to kexec-loader using Linld:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;quiet
console=tty2
vt.default_blu=0,0,0,0,255,0,0,0,0,0,0,0,0,0,0,0
vt.default_grn=0,0,0,0,255,0,0,0,0,0,0,0,0,0,0,0
vt.default_red=0,0,0,0,255,0,0,0,0,0,0,0,0,0,0,0
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;quiet&lt;/strong&gt; hides most kernel log messages, but unfortunately not all of them -
as the &lt;a href="http://www.kernel.org/doc/Documentation/kernel-parameters.txt"&gt;description&lt;/a&gt; of this parameter says:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;quiet&lt;/strong&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;[KNL] Disable most log messages&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;strong&gt;console=tty2&lt;/strong&gt; makes all kexec-loader&amp;#39;s kernel messages go to tty2 - i.e. they
are hidden because tty1 is shown by default.&lt;/p&gt;

&lt;p&gt;The &lt;strong&gt;vt.default_*&lt;/strong&gt; parameters change the Linux kernel&amp;#39;s console palette.
As you can see, I set every colour in the palette to black, &lt;em&gt;except&lt;/em&gt; palette
colour 4. This hid all messages except for those displayed using palette number
4.&lt;/p&gt;

&lt;p&gt;The Linux kernel&amp;#39;s console palette is in a &lt;a href="http://git.kernel.org/?p=linux/kernel/git/stable/linux-stable.git;a=blob;f=drivers/tty/vt/vt.c#l1045"&gt;different order&lt;/a&gt;
to &lt;strong&gt;INT 10H&lt;/strong&gt;&amp;#39;s:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;unsigned char color_table[] = { 0, 4, 2, 6, 1, 5, 3, 7,
                                       8,12,10,14, 9,13,11,15 };
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Palette colour 4 here corresponds to &lt;strong&gt;INT 10H&lt;/strong&gt;&amp;#39;s palette register 1 (i.e.
normally blue). So the effect of this is to hide everything except the
&lt;strong&gt;Welcome!&lt;/strong&gt; message we displayed in the FreeDOS pre-boot environment.&lt;/p&gt;

&lt;h2 id="toc_3"&gt;Tiny Core Linux&lt;/h2&gt;

&lt;p&gt;To keep Tiny Core Linux quiet, I got kexec-loader to boot it with these
parameters:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;quiet
vt.default_blu=0,0,0,0,255,0,0,0,0,0,0,0,0,0,0,0
vt.default_grn=0,0,0,0,255,0,0,0,0,0,0,0,0,0,0,0
vt.default_red=0,0,0,0,255,0,0,0,0,0,0,0,0,0,0,0
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I repeated &lt;strong&gt;vt.default_*&lt;/strong&gt; because otherwise the Linux kernel resets the
palette to the default colours.&lt;/p&gt;

&lt;p&gt;I didn&amp;#39;t boot with &lt;strong&gt;console=tty2&lt;/strong&gt; because I wanted the flexibility to display
messages later in the boot process.&lt;/p&gt;

&lt;h2 id="toc_4"&gt;Summary&lt;/h2&gt;

&lt;p&gt;My goal was to reduce the amount of noise during boot for a PC booting from
Syslinux into FreeDOS then (via Linld) from kexec-loader into Tiny Core Linux.&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;I patched Syslinux to remove all messages apart from the copyright one.&lt;/li&gt;
&lt;li&gt;I patched Syslinux with an extra display file control code to turn the blue
palette register into bright white.&lt;/li&gt;
&lt;li&gt;I displayed a welcome message in FreeDOS using this colour.&lt;/li&gt;
&lt;li&gt;I started kexec-loader with options to turn all except this colour into black.&lt;/li&gt;
&lt;li&gt;I did the same when starting Tiny Core Linux.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;The effect of this is that the following are shown before kexec-loader starts:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;The BIOS blurb.&lt;/li&gt;
&lt;li&gt;The Syslinux copyright message.&lt;/li&gt;
&lt;li&gt;The FreeDOS copyright message.&lt;/li&gt;
&lt;li&gt;The welcome message.&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;After kexec-loader starts, and until X comes up, only the welcome message is
displayed.&lt;/p&gt;

    &lt;hr&gt;
    &lt;div class="pagination pagination-centered btn-group"&gt;
        &lt;a class="btn disabled prev"&gt;&amp;larr; Previous&lt;/a&gt;

        &lt;a class="btn" href="/archive"&gt;Archive&lt;/a&gt;

        &lt;a class="btn next" href="/old-skool-splash-screen" title="Old Skool Splash Screen"&gt;Next &amp;rarr;&lt;/a&gt;
    &lt;/div&gt;
    &lt;hr&gt;
    &lt;div id="disqus_thread"&gt;&lt;/div&gt;
&lt;script&gt;
    var disqus_developer = 1;
    var disqus_shortname = 'davedoesdev'; // required: replace example with your forum shortname
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
&lt;/script&gt;
&lt;noscript&gt;Please enable JavaScript to view the &lt;a href="http://disqus.com/?ref_noscript"&gt;comments powered by Disqus.&lt;/a&gt;&lt;/noscript&gt;
&lt;a href="http://disqus.com" class="dsq-brlink"&gt;blog comments powered by &lt;span class="logo-disqus"&gt;Disqus&lt;/span&gt;&lt;/a&gt;

  &lt;/div&gt;
  
  &lt;div class="span3"&gt;
    &lt;section&gt;
      &lt;h4&gt;Published&lt;/h4&gt;
      &lt;div class="date"&gt;&lt;span&gt;2012-09-16&lt;/span&gt;&lt;/div&gt;
    &lt;/section&gt;

    &lt;section class="tag_box_container_empty" &gt;
      &lt;h4&gt;Categories&lt;/h4&gt;
      &lt;ul class="tag_box"&gt;
      &lt;/ul&gt;
    &lt;/section&gt;

    &lt;section class="tag_box_container" &gt;
      &lt;h4&gt;Tags&lt;/h4&gt;
      &lt;ul class="tag_box"&gt;
          &lt;li&gt;
            &lt;a href="/tags#boot-ref"&gt;boot &lt;span&gt;2&lt;/span&gt;&lt;/a&gt;
          &lt;/li&gt;          &lt;li&gt;
            &lt;a href="/tags#syslinux-ref"&gt;syslinux &lt;span&gt;1&lt;/span&gt;&lt;/a&gt;
          &lt;/li&gt;          &lt;li&gt;
            &lt;a href="/tags#freedos-ref"&gt;freedos &lt;span&gt;1&lt;/span&gt;&lt;/a&gt;
          &lt;/li&gt;          &lt;li&gt;
            &lt;a href="/tags#usb-ref"&gt;usb &lt;span&gt;1&lt;/span&gt;&lt;/a&gt;
          &lt;/li&gt;          &lt;li&gt;
            &lt;a href="/tags#kexec-loader-ref"&gt;kexec-loader &lt;span&gt;1&lt;/span&gt;&lt;/a&gt;
          &lt;/li&gt;          &lt;li&gt;
            &lt;a href="/tags#tinycorelinux-ref"&gt;tinycorelinux &lt;span&gt;2&lt;/span&gt;&lt;/a&gt;
          &lt;/li&gt;      &lt;/ul&gt;
    &lt;/section&gt;
  &lt;/div&gt;
&lt;/div&gt;

      &lt;/div&gt;

      &lt;footer&gt;
        &lt;p&gt;&amp;copy; &lt;a href="mailto:dave@davedoesdev.com"&gt;David Halls&lt;span class="icon-envelope icon-white"&gt;&lt;/span&gt;&lt;/a&gt; 2012 
          with help from &lt;a href="http://ruhoh.com" target="_self" title="The Definitive Technical Blogging Framework"&gt;ruhoh&lt;/a&gt;,
          &lt;a href="http://twitter.github.com/bootstrap/" target="_self"&gt;Twitter Bootstrap&lt;/a&gt; and
          &lt;a href="http://www.glyphicons.com"&gt;Glyphicons&lt;/a&gt;.
        &lt;/p&gt;
        &lt;p&gt;This site uses cookies for &lt;a href="http://www.getclicky.com/terms" target="_self"&gt;analytics&lt;/a&gt; and &lt;a href="http://help.disqus.com/customer/portal/articles/466259-privacy-policy" target="_self"&gt;commenting&lt;/a&gt;.&lt;/p&gt;
      &lt;/footer&gt;
    &lt;/div&gt; &lt;!-- /container --&gt;

    &lt;script&gt;
var clicky_site_ids = clicky_site_ids || [];
clicky_site_ids.push(66642016);
(function() {
  var s = document.createElement('script');
  s.type = 'text/javascript';
  s.async = true;
  s.src = '//static.getclicky.com/js';
  ( document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0] ).appendChild( s );
})();
&lt;/script&gt;
&lt;noscript&gt;&lt;p&gt;&lt;img alt="Clicky" width="1" height="1" src="//in.getclicky.com/66642016ns.gif" /&gt;&lt;/p&gt;&lt;/noscript&gt;
    &lt;!-- Google Prettify --&gt;
&lt;script src="http://cdnjs.cloudflare.com/ajax/libs/prettify/188.0.0/prettify.js"&gt;&lt;/script&gt;
&lt;script&gt;
  var pres = document.getElementsByTagName("pre");
  for (var i=0; i &lt; pres.length; ++i) {
    pres[i].className = "prettyprint ";
  }
  prettyPrint();
&lt;/script&gt;
&lt;!-- end Google Prettify --&gt;
  &lt;/body&gt;
&lt;/html&gt;
</description>
    </item>
  </channel>
</rss>
